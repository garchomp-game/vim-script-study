# vim script学習メモ

1.0e6や、1.0e-3等、指数を指定する場合は、
小数点(.)等を省略することはできない。

日本語の文字の場合、配列型として引数を指定すると
ユニコードの確認が可能になる

文字列、シングルクォートとダブルクォートの違い。
例えば、ダブルクォートの場合、特殊文字を解釈する事ができる
※\n等の改行文字等

リスト型は混在可能

文字列内においての\000と\x00は、終端文字として扱われる（つまりEOF）
それ移行は読まれなくなるので、途中で止めたい場合はこれらの文字コードを
使うと良い。

配列の追加は

```vim
let list = [
\ 'foo',
\ 'bar',
\ 'baz',
\ 'qux'
\ ]
```

と追加してもいいが、この書き方はcpoptionsにCフラグが含まれているときのみ
有効である

処理も結構重くなりがちなので、addメソッドを使うことが推奨されている。

```vim
let list = []
call add(list, 'foo')
call add(list, 'bar')
call add(list, 'baz')
call add(list, 'qux')
```

TIPS: 関数はcallを使って呼び出す
なお、vim9scriptの限り、callはオプションであり、使わなくてもよい。

定義済みのリストの数を取得するには、lenメソッドを使う
配列の内容を取得する場合、通常の配列と同じである。
getメソッドを使うと、エラー発生した場合は第2引数の内容を実行する

```vim
echo len(list)
echo list[3] "error
echo get(list, 3, 'not found') "ok
```

list関連のメソッドは以下のようなものがある

|操作    |説明                    |
|--------|------------------------|
|len()   |要素の個数を取得する    |
|[]      |要素を参照する(取得する)|
|add()   |要素を追加する          |
|remove()|要素を削除する          |
|join()  |要素を連結し文字列にする|

## 辞書形について

辞書型の宣言は以下の通り

```vim
let en2ja = {'one': 'いち', 'two': 'に', 'three': 'さん'}
echo en2ja['one']
```

キーには数字を指定することも可能だが、内部的には
文字列に変換される。
lenで辞書型の要素数の取得が可能

|操作     |説明                            |
|---------|--------------------------------|
|len()    |要素の個数を取得する            |
|get()    |要素の値を取得する              |
|[]       |要素の値を参照する              |
|has_key()|キーが存在するか確認する        |
|remove() |要素を削除する                  |
|keys()   |キーの一覧をリストとして取得する|
|values() |値の一覧をリストとして取得する  |

## vimオブジェクト

vimには暗黙的な方が存在する

- バッファ
- ウィンドウ

vim scriptから見ると厳密には型とは言い難いが、操作対象となるという
意味では方と捉えてしまうのもあり。

### バッファ操作

バッファの行に追加する場合、append関数で実現できる

```vim
append(0, 'foo')
```

文字連結やstringメソッドを使い、このような事もできる。

```vim
call append(0, 'echo' . string(2980 * 1.08))
```

## 式とその評価

vimの関数は、expression(式)であるが、vimはコマンドから開始しなければならない。
そのため、vimでは式から書いたらエラーとなるのであった。
:callはできても、:append()はコマンドではないため、エラーとなる。

:echoや:let等がある場合は、先にechoコマンドやletコマンドから開始しているため、
エラーにならない

```vim
" 以下の書き方は正しい
:echo len('foobar')
:let l = len('foobar')
:echo l
" 以下は実行できるが、戻り値は無視される。
:call len('foobar')
```

### 部分文字列の操作

文字列は、配列として操作することができる。
リスト操作のような形で操作が可能となる。

```vim
let s = "ABCDE"
echo s[0]
echo s[1]
echo s[1:3] " BCD
```

複数指定する場合は、[start:end]であることに注意。
end-1ではない。(javaのsubtstringとごっちゃにならないように注意)

つまり、以下の２つは同じ意味となる

```vim
echo s[2]
echo s[2:2]
```

開始位置や終了位置のどちらかを省略することもできる

```vim
echo s[:2]
echo s[2:]
```

マイナスにすると、末尾から指定したことになる

```vim
echo s[-2:] " DE
echo s[:-2] " ABCD
echo s[-4:-2] " BCD
```

### matchstr()

matchstrは、正規表現を指定してマッチした部分文字列を返す。
[x:y]での取り出しは、シンプルすぎて実務に向かないことがある。
その場合、matchstrを使うと、正規表現文字を使ったパースができる。

```vim
let s = 'year 2023'
echo matchstr(s, '\d\+') "2013
```
